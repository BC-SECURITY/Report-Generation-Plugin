from __future__ import print_function

import logging
import threading

from jinja2 import Environment, FileSystemLoader
from md2pdf.core import md2pdf
from sqlalchemy import and_, func, or_
from tabulate import tabulate

import empire.server.common.helpers as helpers
from empire.server.common.plugins import Plugin
from empire.server.core.db import models
from empire.server.core.db.base import SessionLocal as Session
from empire.server.core.plugin_service import PluginService
from empire.server.plugins.advanced_reporting.mitre import Attack

log = logging.getLogger(__name__)

class Plugin(Plugin):
    lock = threading.Lock()
    def onLoad(self):
        """
        any custom loading behavior - called by init, so any
        behavior you'd normally put in __init__ goes here
        """
        self.info = {
                        'Name': 'advanced-reporting',
                        "Authors": [
                            {
                                "Name": "Anthony Rose",
                                "Handle": "@Cx01N",
                                "Link": "https://twitter.com/Cx01N_",
                            }
                        ],
                        'Description': 'Generate enhanced reports and markdown files for customized PDF reports',
                        'Software': '',
                        'Techniques': [''],
                        'Comments': [],
                    }

        self.options = {
            'report': {
                'Description': 'Report to generate by the server.',
                'Required': True,
                'Value': 'all',
                "SuggestedValues": ["all", "empire", "session", "credential", "master", "module"],
                "Strict": True,
            }
        }

    def execute(self, command):
        try:
            self.thread = helpers.KThread(target=self.pdf_report)
            self.thread.daemon = True
            self.thread.start()
            return
        except Exception as e:
            log.error(e)
            self.plugin_service.plugin_socketio_message(self.info["Name"], f"[!] {e}")
            return False

    def get_commands(self):
        return self.commands

    def register(self, mainMenu):
        """
        Any modifications to the mainMenu go here - e.g.
        registering functions to be run by user commands
        """
        self.installPath = mainMenu.installPath
        self.main_menu = mainMenu
        self.plugin_service: PluginService = mainMenu.pluginsv2
        self.logo = self.installPath + '/plugins/advanced_reporting/templates/empire.png'

    def pdf_report(self):
        """
        Generate enhanced reports and markdown files for customized PDF reports
        """
        self.empire_report()
        self.session_report()
        self.credential_report()
        self.master_log()
        self.module_report()
        self.plugin_service.plugin_socketio_message(self.info['Name'], "[+] All report generated")

    def generate_pdf(self, md_template: str, temp_var: dict, md_file: str, pdf_out:str):
        """
        Generate pdf from markdown files using mustache templating
        """
        env = Environment(loader=FileSystemLoader(self.installPath + "/plugins/advanced_reporting/templates/"))
        template = env.get_template(md_template)

        # Save markdown to file, if it requires editing
        md_out = template.render(temp_var)
        with open(md_file, 'w') as f:
            f.write(md_out)

        # Generate PDF from MD file
        md2pdf(pdf_out, md_content=md_out, css_file_path=self.installPath + '/plugins/advanced_reporting/templates/style.css',
               base_url='.')

    def empire_report(self):
        self.plugin_service.plugin_socketio_message(self.info['Name'], "[*] Generating Empire Report")

        # Pull techniques and software used with Empire
        software, techniques = Attack(self.main_menu).attack_searcher()

        # Set info from database
        description = software['description']

        # Switch rows and columns of platforms
        platforms = software['x_mitre_platforms']
        platforms = [[platforms[j] for j in range(len(platforms))]]

        # Create list of techniques
        used_techniques = list([])
        for i in range(len(techniques)):
            used_techniques.append('<h3>' + techniques[i]['name'] + '</h3>')
            used_techniques.append(techniques[i]['description'])

        # Add data to Jinja2 Template
        template_vars = {"logo": self.logo,
                         "description": description,
                         "platforms": tabulate(platforms, tablefmt='html'),
                         "techniques": used_techniques}

        self.generate_pdf(md_template='empire_report_template.md', temp_var=template_vars,
                          md_file=self.installPath + '/plugins/advanced_reporting/markdown/Empire_Report.md',
                          pdf_out=self.installPath + '/plugins/advanced_reporting/Empire_Report.pdf')

    def session_report(self):
        self.plugin_service.plugin_socketio_message(self.info['Name'], "[*] Generating Session Report")

        # Pull agent data from database
        agents = Session().query(models.Agent.session_id,
                                 models.Agent.hostname,
                                 models.Agent.username,
                                 models.Agent.checkin_time
                                 ).all()

        # Add headers for table
        sessions = [('SessionID', 'Hostname', 'User Name', 'First Check-in')]
        sessions.extend(agents)

        # Add data to Jinja2 Template
        template_vars = {"logo": self.logo,
                         "sessions": tabulate(sessions, tablefmt='html')}

        self.generate_pdf(md_template='sessions_template.md', temp_var=template_vars,
                          md_file=self.installPath + '/plugins/advanced_reporting/markdown/Sessions_Report.md',
                          pdf_out=self.installPath + '/plugins/advanced_reporting/Sessions_Report.pdf')

    def credential_report(self):
        self.plugin_service.plugin_socketio_message(self.info['Name'], "[*] Generating Credentials Report")

        # Pull agent data from database
        data = Session().query(models.Credential.domain,
                               models.Credential.username,
                               models.Credential.host,
                               models.Credential.credtype,
                               models.Credential.password
                               ).all()

        # Add headers for table
        creds = [('Domain', 'Username', 'Host', 'Cred Type', 'Password')]
        creds.extend(data)

        # Add data to Jinja2 Template
        template_vars = {"logo": self.logo,
                         "creds": tabulate(creds, tablefmt='html')}

        self.generate_pdf(md_template='credentials_template.md', temp_var=template_vars,
                          md_file=self.installPath + '/plugins/advanced_reporting/markdown/Credentials_Report.md',
                          pdf_out=self.installPath + '/plugins/advanced_reporting/Credentials_Report.pdf')

    def master_log(self):
        self.plugin_service.plugin_socketio_message(self.info['Name'], "[*] Generating Master Log Report")

        data = self.run_report_query()

        # Format text as a string and print to new line
        log = ''
        for row in data:
            row = list(row)
            for n in range(len(row)):
                if isinstance(row[n], bytes):
                    row[n] = row[n].decode('UTF-8')
                if type(row[n]) == str:
                    row[n] = str(row[n]).replace('\n', ' <br> ')
            log = log + ' <br> ' + xstr(row[0]) + ' - ' + xstr(row[3]) + ' (' + xstr(row[2]) + ')> ' + xstr(
                row[5]) + xstr(row[6]) + xstr(row[7]) + ' <br> '

        # Add data to Jinja2 Template
        template_vars = {"logo": self.logo,
                         "log": log}

        self.generate_pdf(md_template='masterlog_template.md', temp_var=template_vars,
                          md_file=self.installPath + '/plugins/advanced_reporting/markdown/Masterlog_Report.md',
                          pdf_out=self.installPath + '/plugins/advanced_reporting/Masterlog_Report.pdf')

    def module_report(self):
        # TODO: Pull all software for module report
        #software, techniques = Attack(self.mainMenu).attack_searcher()

        # Pull all techniques from MITRE database
        techniques = Attack(self.main_menu).all_attacks()
        self.plugin_service.plugin_socketio_message(self.info['Name'], "[*] Generating Module Report")

        # Pull agent data from database
        data = Session().query(models.Tasking.module_name.distinct()).filter(
            models.Tasking.module_name != None).all()

        ttp = list([])
        module_name = list([])
        for module_directory in data:
            try:
                ttp.append(self.main_menu.modules.modules[module_directory[0]].info['Techniques'])
                module_name.append(self.main_menu.modules.modules[module_directory[0]].info['Name'])
            except:
                continue

        # Create list of techniques
        used_techniques = list([])
        for ttp_list in ttp:
            for ttp_name in ttp_list:
                for i in range(len(techniques)):
                    if ttp_name in techniques[i]._inner['external_references'][0]._inner['external_id']:
                        try:
                            used_techniques.append('<h3>' + techniques[i]['name'] + '</h3>')
                            used_techniques.append(
                                '**Empire Modules Used:** ' + module_name[ttp.index(ttp_list)] + '<br><br>')
                            used_techniques.append(techniques[i]._inner['description'])
                        except:
                            pass

        # Add data to Jinja2 Template
        template_vars = {"logo": self.logo,
                         "techniques": used_techniques}

        self.generate_pdf(md_template='module_report_template.md', temp_var=template_vars,
                          md_file=self.installPath + '/plugins/advanced_reporting/markdown/Module_Report.md',
                          pdf_out=self.installPath + '/plugins/advanced_reporting/Module_Report.pdf')

    def run_report_query(self):
        reporting_sub_query = (
            Session()
                .query(
                models.Reporting,
                self.substring(Session(), models.Reporting.name, "/").label(
                    "agent_name"
                ),
            )
                .filter(
                and_(
                    models.Reporting.name.ilike("agent%"),
                    or_(
                        models.Reporting.event_type == "task",
                        models.Reporting.event_type == "checkin",
                    ),
                )
            )
                .subquery()
        )

        return (
            Session()
                .query(
                reporting_sub_query.c.timestamp,
                reporting_sub_query.c.event_type,
                reporting_sub_query.c.agent_name,
                reporting_sub_query.c.taskID,
                models.Agent.hostname,
                models.User.username,
                models.Tasking.input.label("task"),
                models.Tasking.output.label("results"),
            )
                .join(
                models.Tasking,
                and_(
                    models.Tasking.id == reporting_sub_query.c.taskID,
                    models.Tasking.agent_id == reporting_sub_query.c.agent_name,
                ),
                isouter=True,
            )
                .join(models.User, models.User.id == models.Tasking.user_id, isouter=True)
                .join(
                models.Agent,
                models.Agent.session_id == reporting_sub_query.c.agent_name,
                isouter=True,
            )
                .all()
        )

    def substring(self, session, column, delimeter):
        """
        https://stackoverflow.com/a/57763081
        """
        if session.bind.dialect.name == 'sqlite':
            return func.substr(column, func.instr(column, delimeter) + 1)
        elif session.bind.dialect.name == 'mysql':
            return func.substring_index(column, delimeter, -1)

    def shutdown(self):
        """
        Kills additional processes that were spawned
        """
        pass


def xstr(s):
    """Safely cast to a string with a handler for None"""
    if s is None:
        return ''
    return str(s)
